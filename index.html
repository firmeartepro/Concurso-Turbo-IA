<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSmart Pro - Sistema Completo de Estudos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .typing-animation { border-right: 2px solid #667eea; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { border-color: transparent; } 51%, 100% { border-color: #667eea; } }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .chat-message { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .question-card { transition: all 0.3s ease; border-left: 4px solid transparent; }
        .question-card.correct { border-left-color: #10b981; background-color: #f0fdf4; }
        .question-card.incorrect { border-left-color: #ef4444; background-color: #fef2f2; }
        .study-material { background: linear-gradient(145deg, #f8fafc, #e2e8f0); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold">EduSmart Pro</h2>
            <p class="text-lg opacity-90">Carregando seu ambiente de estudos...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-graduation-cap text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">EduSmart Pro</h1>
                <p class="text-gray-600 mt-2">Sistema Inteligente de Estudos</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <button type="submit" 
                        class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition duration-300">
                    Entrar
                </button>
            </form>
            
            <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="min-h-screen bg-gray-50" style="display: none;">
        <!-- Admin Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <i class="fas fa-user-shield text-2xl mr-3"></i>
                        <h1 class="text-2xl font-bold">Painel Administrativo</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="adminName" class="text-lg"></span>
                        <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition duration-300">
                            <i class="fas fa-sign-out-alt mr-2"></i>Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-users text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total de Usuários</p>
                            <p id="totalUsers" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-user-check text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Usuários Ativos</p>
                            <p id="activeUsers" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-book text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Simulados Realizados</p>
                            <p id="totalSimulations" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-chart-line text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Taxa de Aprovação</p>
                            <p id="approvalRate" class="text-2xl font-bold text-gray-900">0%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Gerenciar Usuários</h2>
                    <button onclick="showAddUserModal()" class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 transition duration-300">
                        <i class="fas fa-plus mr-2"></i>Adicionar Usuário
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plano</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Dashboard -->
    <div id="studentDashboard" class="min-h-screen bg-gray-50" style="display: none;">
        <!-- Student Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <i class="fas fa-graduation-cap text-2xl mr-3"></i>
                        <h1 class="text-2xl font-bold">EduSmart Pro</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="studentName" class="text-lg"></span>
                        <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition duration-300">
                            <i class="fas fa-sign-out-alt mr-2"></i>Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Student Navigation -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showStudentSection('dashboard')" class="student-nav-btn py-4 px-2 border-b-2 border-purple-500 text-purple-600 font-medium">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </button>
                    <button onclick="showStudentSection('materials')" class="student-nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                        <i class="fas fa-book mr-2"></i>Materiais
                    </button>
                    <button onclick="showStudentSection('simulations')" class="student-nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                        <i class="fas fa-clipboard-list mr-2"></i>Simulados
                    </button>
                    <button onclick="showStudentSection('chat')" class="student-nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                        <i class="fas fa-robot mr-2"></i>Chat IA
                    </button>
                    <button onclick="showStudentSection('progress')" class="student-nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                        <i class="fas fa-chart-line mr-2"></i>Progresso
                    </button>
                </div>
            </div>
        </nav>

        <!-- Student Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Section -->
            <div id="studentDashboardSection" class="student-section">
                <!-- AI Configuration -->
                <div id="aiConfigSection" class="bg-gradient-to-r from-purple-500 to-blue-600 rounded-xl shadow-lg p-6 mb-8 text-white">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-robot text-3xl mr-4"></i>
                        <div>
                            <h2 class="text-2xl font-bold">Configure sua IA Pessoal</h2>
                            <p class="opacity-90">Conecte sua própria IA Gemini gratuita em 3 passos simples</p>
                        </div>
                    </div>
                    
                    <div id="aiSetupSteps" class="bg-white bg-opacity-10 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">📋 Passo a Passo - Super Fácil!</h3>
                        
                        <div class="space-y-4">
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4 mt-1">
                                    <span class="font-bold">1</span>
                                </div>
                                <div>
                                    <p class="font-semibold">Acesse o Google AI Studio</p>
                                    <p class="text-sm opacity-90">Clique no link: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-yellow-300">https://aistudio.google.com/app/apikey</a></p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4 mt-1">
                                    <span class="font-bold">2</span>
                                </div>
                                <div>
                                    <p class="font-semibold">Faça login com sua conta Google</p>
                                    <p class="text-sm opacity-90">Use qualquer conta Google (Gmail). É 100% gratuito!</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4 mt-1">
                                    <span class="font-bold">3</span>
                                </div>
                                <div>
                                    <p class="font-semibold">Clique em "Create API Key"</p>
                                    <p class="text-sm opacity-90">Copie a chave que aparece (começa com "AIza...")</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-yellow-400 bg-opacity-20 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-lightbulb text-yellow-300 mr-2"></i>
                                <p class="text-sm"><strong>Dica:</strong> Sua chave é pessoal e segura. Ninguém mais terá acesso!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Cole sua chave da IA aqui:</label>
                            <div class="flex">
                                <input type="password" id="geminiApiKey" placeholder="AIza..." 
                                       class="flex-1 px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-l-lg text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50">
                                <button onclick="toggleApiKeyVisibility()" class="px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 border-l-0 text-white hover:bg-opacity-30">
                                    <i id="toggleIcon" class="fas fa-eye"></i>
                                </button>
                                <button onclick="saveGeminiKey()" class="px-6 py-3 bg-white text-purple-600 font-semibold rounded-r-lg hover:bg-opacity-90 transition duration-300">
                                    Salvar
                                </button>
                            </div>
                        </div>
                        
                        <div id="aiStatus" class="hidden">
                            <div class="flex items-center p-3 bg-green-400 bg-opacity-20 rounded-lg">
                                <i class="fas fa-check-circle text-green-300 mr-3"></i>
                                <span class="text-sm">IA conectada com sucesso! Agora você pode usar o chat inteligente.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contest Configuration -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Configurar Concurso</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Concurso</label>
                            <select id="contestSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">Selecione um concurso</option>
                                <option value="enem">ENEM</option>
                                <option value="vestibular">Vestibular</option>
                                <option value="concurso-publico">Concurso Público</option>
                                <option value="oab">OAB</option>
                                <option value="medicina">Medicina</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Área de Interesse</label>
                            <select id="areaSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">Selecione uma área</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="saveContestConfig()" class="mt-6 gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition duration-300">
                        <i class="fas fa-save mr-2"></i>Salvar Configuração
                    </button>
                </div>

                <!-- Study Plan -->
                <div id="studyPlanSection" class="bg-white rounded-xl shadow-lg p-6 mb-8" style="display: none;">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Seu Plano de Estudos</h2>
                    <div id="studyPlanContent" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Horas Estudadas</p>
                                <p id="studyHours" class="text-2xl font-bold text-gray-900">0h</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Questões Resolvidas</p>
                                <p id="questionsAnswered" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-percentage text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Taxa de Acerto</p>
                                <p id="accuracyRate" class="text-2xl font-bold text-gray-900">0%</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-trophy text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Ranking</p>
                                <p id="userRanking" class="text-2xl font-bold text-gray-900">#0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Materials Section -->
            <div id="studentMaterialsSection" class="student-section" style="display: none;">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Materiais de Estudo</h2>
                    <div id="materialsContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="study-material rounded-lg p-6 card-hover">
                            <div class="text-center mb-4">
                                <i class="fas fa-book text-4xl text-purple-600 mb-2"></i>
                                <h3 class="text-lg font-semibold">Configure seu concurso</h3>
                                <p class="text-gray-600 text-sm">Primeiro configure seu concurso no Dashboard para ver os materiais</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulations Section -->
            <div id="studentSimulationsSection" class="student-section" style="display: none;">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Simulados</h2>
                    <div id="simulationsContent">
                        <div class="text-center py-12">
                            <i class="fas fa-clipboard-list text-6xl text-gray-400 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-600 mb-2">Configure seu concurso primeiro</h3>
                            <p class="text-gray-500">Vá para o Dashboard e configure seu concurso para ver os simulados disponíveis</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="studentChatSection" class="student-section" style="display: none;">
                <div class="bg-white rounded-xl shadow-lg p-6 h-96 flex flex-col">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Chat com IA - Professor Virtual</h2>
                    
                    <div id="chatNotConfigured" class="flex-1 flex items-center justify-center text-center">
                        <div>
                            <i class="fas fa-robot text-6xl text-gray-400 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-600 mb-2">Configure sua IA primeiro</h3>
                            <p class="text-gray-500 mb-4">Vá para o Dashboard e conecte sua IA Gemini gratuita</p>
                            <button onclick="showStudentSection('dashboard')" class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90">
                                Configurar IA
                            </button>
                        </div>
                    </div>
                    
                    <div id="chatConfigured" class="flex-1 flex flex-col" style="display: none;">
                        <div id="chatMessages" class="flex-1 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg">
                            <div class="chat-message mb-4">
                                <div class="flex items-start">
                                    <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-robot text-white text-sm"></i>
                                    </div>
                                    <div class="bg-white rounded-lg p-3 shadow-sm">
                                        <p class="text-gray-800">Olá! Sou seu professor virtual. Como posso ajudar você hoje? Posso explicar matérias, tirar dúvidas e criar exercícios personalizados!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex">
                            <input type="text" id="chatInput" placeholder="Digite sua pergunta..." 
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   onkeypress="if(event.key==='Enter') sendMessage()">
                            <button onclick="sendMessage()" class="gradient-bg text-white px-6 py-3 rounded-r-lg hover:opacity-90 transition duration-300">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="studentProgressSection" class="student-section" style="display: none;">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Progresso por Matéria</h2>
                        <div id="subjectProgress" class="space-y-4">
                            <div class="text-center py-8">
                                <i class="fas fa-chart-bar text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">Configure seu concurso para ver o progresso</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Histórico de Simulados</h2>
                        <div id="simulationHistory" class="space-y-4">
                            <div class="text-center py-8">
                                <i class="fas fa-history text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">Nenhum simulado realizado ainda</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Adicionar Usuário</h2>
            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                    <input type="text" id="newUserName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="newUserEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="newUserPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Plano</label>
                    <select id="newUserPlan" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="basic">Básico</option>
                        <option value="premium">Premium</option>
                        <option value="vip">VIP</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Expiração</label>
                    <input type="date" id="newUserExpiry" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="hideAddUserModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90">
                        Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Simulation Modal -->
    <div id="simulationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="simulationTitle" class="text-2xl font-bold text-gray-800">Simulado</h2>
                <button onclick="closeSimulation()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="simulationContent">
                <!-- Simulation content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - SUBSTITUA PELAS SUAS CHAVES
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI",
            authDomain: "SEU_PROJECT_ID.firebaseapp.com",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_PROJECT_ID.appspot.com",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Gemini API Configuration
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';
        let userGeminiKey = null;

        // Global Variables
        let currentUser = null;
        let currentContest = null;
        let currentArea = null;
        let studyMaterials = {};
        let questionBank = {};

        // Contest and Area Configuration
        const contestAreas = {
            'enem': ['Linguagens', 'Matemática', 'Ciências da Natureza', 'Ciências Humanas', 'Redação'],
            'vestibular': ['Português', 'Matemática', 'Física', 'Química', 'Biologia', 'História', 'Geografia'],
            'concurso-publico': ['Português', 'Matemática', 'Direito Constitucional', 'Direito Administrativo', 'Informática'],
            'oab': ['Direito Constitucional', 'Direito Civil', 'Direito Penal', 'Direito do Trabalho', 'Ética Profissional'],
            'medicina': ['Anatomia', 'Fisiologia', 'Patologia', 'Farmacologia', 'Clínica Médica']
        };

        // Study Materials Database
        const studyMaterialsDB = {
            'enem': {
                'Matemática': {
                    topics: ['Álgebra', 'Geometria', 'Estatística', 'Funções', 'Trigonometria'],
                    videos: [
                        { title: 'Função Quadrática - Teoria Completa', url: 'https://youtube.com/watch?v=exemplo1', duration: '45min' },
                        { title: 'Geometria Plana - Exercícios', url: 'https://youtube.com/watch?v=exemplo2', duration: '30min' }
                    ],
                    pdfs: [
                        { title: 'Resumo de Funções', url: '#', pages: 15 },
                        { title: 'Exercícios de Geometria', url: '#', pages: 25 }
                    ]
                },
                'Português': {
                    topics: ['Gramática', 'Literatura', 'Interpretação de Texto', 'Redação'],
                    videos: [
                        { title: 'Análise Sintática Completa', url: 'https://youtube.com/watch?v=exemplo3', duration: '60min' },
                        { title: 'Literatura Brasileira - Romantismo', url: 'https://youtube.com/watch?v=exemplo4', duration: '40min' }
                    ],
                    pdfs: [
                        { title: 'Guia de Redação ENEM', url: '#', pages: 30 },
                        { title: 'Resumo de Literatura', url: '#', pages: 20 }
                    ]
                }
            }
        };

        // Question Bank
        const questionBankDB = {
            'enem': {
                'Matemática': [
                    {
                        question: "Uma função quadrática f(x) = ax² + bx + c tem vértice no ponto (2, -1) e passa pelo ponto (0, 3). Qual o valor de a?",
                        options: ["a) 1", "b) 2", "c) -1", "d) -2", "e) 3"],
                        correct: 0,
                        explanation: "Usando as condições dadas: vértice (2, -1) e ponto (0, 3), podemos determinar que a = 1."
                    },
                    {
                        question: "Em um triângulo retângulo, os catetos medem 3 cm e 4 cm. Qual a medida da hipotenusa?",
                        options: ["a) 5 cm", "b) 6 cm", "c) 7 cm", "d) 8 cm", "e) 9 cm"],
                        correct: 0,
                        explanation: "Pelo teorema de Pitágoras: h² = 3² + 4² = 9 + 16 = 25, logo h = 5 cm."
                    }
                ],
                'Português': [
                    {
                        question: "Qual figura de linguagem está presente na frase: 'O vento sussurrava segredos'?",
                        options: ["a) Metáfora", "b) Personificação", "c) Hipérbole", "d) Ironia", "e) Antítese"],
                        correct: 1,
                        explanation: "Personificação: atribuição de características humanas (sussurrar segredos) a seres inanimados (vento)."
                    }
                ]
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                checkAuthState();
            }, 2000);
        });

        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.isAdmin) {
                        showAdminDashboard(userData);
                    } else {
                        showStudentDashboard(userData);
                    }
                }
            } else {
                showLoginScreen();
            }
        });

        function checkAuthState() {
            const user = auth.currentUser;
            if (!user) {
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('studentDashboard').style.display = 'none';
        }

        function showAdminDashboard(userData) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('studentDashboard').style.display = 'none';
            document.getElementById('adminName').textContent = userData.name;
            loadAdminData();
        }

        function showStudentDashboard(userData) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('studentDashboard').style.display = 'block';
            document.getElementById('studentName').textContent = userData.name;
            loadStudentData(userData);
        }

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                document.getElementById('loginError').textContent = 'Email ou senha incorretos';
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        // Logout Function
        function logout() {
            auth.signOut();
        }

        // Admin Functions
        async function loadAdminData() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const users = [];
                let activeUsers = 0;
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (!userData.isAdmin) {
                        users.push({ id: doc.id, ...userData });
                        if (userData.active) activeUsers++;
                    }
                });

                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('activeUsers').textContent = activeUsers;
                document.getElementById('totalSimulations').textContent = Math.floor(Math.random() * 500) + 100;
                document.getElementById('approvalRate').textContent = Math.floor(Math.random() * 30) + 70 + '%';

                displayUsersTable(users);
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        function displayUsersTable(users) {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${user.plan}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.active ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="toggleUserStatus('${user.id}', ${!user.active})" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            ${user.active ? 'Desativar' : 'Ativar'}
                        </button>
                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">
                            Excluir
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'flex';
        }

        function hideAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('addUserForm').reset();
        }

        // Add User Form Handler
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const plan = document.getElementById('newUserPlan').value;
            const expiryDate = document.getElementById('newUserExpiry').value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    plan: plan,
                    expiryDate: expiryDate,
                    active: true,
                    isAdmin: false,
                    createdDate: new Date().toISOString().split('T')[0]
                });

                hideAddUserModal();
                loadAdminData();
                alert('Usuário adicionado com sucesso!');
            } catch (error) {
                alert('Erro ao adicionar usuário: ' + error.message);
            }
        });

        async function toggleUserStatus(userId, newStatus) {
            try {
                await db.collection('users').doc(userId).update({
                    active: newStatus
                });
                loadAdminData();
            } catch (error) {
                alert('Erro ao alterar status do usuário');
            }
        }

        async function deleteUser(userId) {
            if (confirm('Tem certeza que deseja excluir este usuário?')) {
                try {
                    await db.collection('users').doc(userId).delete();
                    loadAdminData();
                } catch (error) {
                    alert('Erro ao excluir usuário');
                }
            }
        }

        // Student Functions
        function loadStudentData(userData) {
            // Load AI configuration if exists
            if (userData.geminiApiKey) {
                userGeminiKey = userData.geminiApiKey;
                document.getElementById('geminiApiKey').value = userGeminiKey;
                document.getElementById('aiStatus').classList.remove('hidden');
                document.getElementById('aiConfigSection').style.display = 'none';
                updateChatInterface(true);
            } else {
                updateChatInterface(false);
            }

            // Load contest configuration if exists
            if (userData.contest && userData.area) {
                currentContest = userData.contest;
                currentArea = userData.area;
                document.getElementById('contestSelect').value = currentContest;
                updateAreaOptions();
                document.getElementById('areaSelect').value = currentArea;
                loadStudyPlan();
                loadMaterials();
                loadSimulations();
            }

            // Load stats
            document.getElementById('studyHours').textContent = userData.studyHours || '0h';
            document.getElementById('questionsAnswered').textContent = userData.questionsAnswered || '0';
            document.getElementById('accuracyRate').textContent = (userData.accuracyRate || 0) + '%';
            document.getElementById('userRanking').textContent = '#' + (userData.ranking || 'N/A');
        }

        // AI Configuration Functions
        function toggleApiKeyVisibility() {
            const input = document.getElementById('geminiApiKey');
            const icon = document.getElementById('toggleIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        async function saveGeminiKey() {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            
            if (!apiKey) {
                alert('Por favor, insira sua chave da API');
                return;
            }

            if (!apiKey.startsWith('AIza')) {
                alert('❌ CHAVE INVÁLIDA!\n\nA chave deve começar com "AIza"\n\nSua chave atual: ' + apiKey.substring(0, 10) + '...\n\n✅ COMO CORRIGIR:\n1. Vá para: https://aistudio.google.com/app/apikey\n2. Faça login com Google\n3. Clique "Create API Key"\n4. Copie a chave completa (começa com AIza)');
                return;
            }

            // Show loading
            const saveButton = event.target;
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Testando...';
            saveButton.disabled = true;

            try {
                console.log('🔍 Testando chave da API...');
                
                // Test the API key with a simple request
                const testResponse = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'Teste'
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 10
                        }
                    })
                });

                console.log('📡 Status da resposta:', testResponse.status);
                
                let responseData;
                try {
                    responseData = await testResponse.json();
                    console.log('📄 Dados da resposta:', responseData);
                } catch (parseError) {
                    console.error('❌ Erro ao fazer parse da resposta:', parseError);
                    throw new Error('Resposta inválida da API');
                }
                
                if (testResponse.ok && responseData.candidates && responseData.candidates.length > 0) {
                    console.log('✅ API funcionando!');
                    
                    // Save to user profile
                    await db.collection('users').doc(currentUser.uid).update({
                        geminiApiKey: apiKey
                    });

                    userGeminiKey = apiKey;
                    document.getElementById('aiStatus').classList.remove('hidden');
                    document.getElementById('aiConfigSection').style.display = 'none';
                    updateChatInterface(true);
                    
                    alert('🎉 IA CONECTADA COM SUCESSO!\n\nAgora você pode usar o chat inteligente!');
                } else {
                    console.error('❌ Erro da API:', responseData);
                    
                    let errorMessage = '❌ ERRO ESPECÍFICO:\n\n';
                    
                    if (responseData.error) {
                        const error = responseData.error;
                        console.log('🔍 Detalhes do erro:', error);
                        
                        if (error.code === 400) {
                            if (error.message.includes('API key not valid')) {
                                errorMessage += '🔑 CHAVE INVÁLIDA\n\nSua chave não foi aceita pelo Google.\n\n✅ SOLUÇÃO:\n1. Vá para: https://aistudio.google.com/app/apikey\n2. Delete a chave atual\n3. Crie uma nova chave\n4. Copie e cole aqui';
                            } else if (error.message.includes('quota')) {
                                errorMessage += '📊 COTA EXCEDIDA\n\nVocê atingiu o limite gratuito.\n\n✅ SOLUÇÃO:\n1. Aguarde até amanhã\n2. Ou crie uma nova conta Google\n3. Gere uma nova chave';
                            } else {
                                errorMessage += `🔧 ERRO TÉCNICO:\n${error.message}\n\n✅ TENTE:\n1. Criar nova chave\n2. Verificar se aceitou os termos`;
                            }
                        } else if (error.code === 403) {
                            errorMessage += '🚫 ACESSO NEGADO\n\nA API não está ativada.\n\n✅ SOLUÇÃO:\n1. Vá para: https://aistudio.google.com/app/apikey\n2. Aceite todos os termos\n3. Ative a API Gemini\n4. Gere nova chave';
                        } else {
                            errorMessage += `❓ ERRO DESCONHECIDO:\nCódigo: ${error.code}\nMensagem: ${error.message}`;
                        }
                    } else if (testResponse.status === 404) {
                        errorMessage += '🔍 URL INCORRETA\n\nA API não foi encontrada.\n\n✅ POSSÍVEL CAUSA:\nProblema temporário do Google.\nTente novamente em alguns minutos.';
                    } else {
                        errorMessage += `📡 ERRO HTTP ${testResponse.status}\n\nResposta: ${JSON.stringify(responseData, null, 2)}`;
                    }
                    
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('💥 Erro geral:', error);
                
                let userMessage = '❌ ERRO DE CONEXÃO:\n\n';
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    userMessage += '🌐 SEM INTERNET\n\nVerifique sua conexão com a internet.';
                } else if (error.message.includes('CORS')) {
                    userMessage += '🔒 ERRO DE SEGURANÇA\n\nProblema de CORS. Tente:\n1. Usar outro navegador\n2. Desativar extensões\n3. Limpar cache';
                } else {
                    userMessage += `🔧 ERRO TÉCNICO:\n${error.message}\n\n🆘 PRECISA DE AJUDA?\n\n1. Copie este erro\n2. Mande para o suporte\n3. Inclua sua chave (primeiros 10 caracteres): ${apiKey.substring(0, 10)}...`;
                }
                
                alert(userMessage);
            } finally {
                // Restore button
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            }
        }

        function updateChatInterface(isConfigured) {
            const notConfigured = document.getElementById('chatNotConfigured');
            const configured = document.getElementById('chatConfigured');
            
            if (isConfigured) {
                notConfigured.style.display = 'none';
                configured.style.display = 'flex';
            } else {
                notConfigured.style.display = 'flex';
                configured.style.display = 'none';
            }
        }

        function showStudentSection(section) {
            // Hide all sections
            document.querySelectorAll('.student-section').forEach(el => {
                el.style.display = 'none';
            });

            // Show selected section
            document.getElementById('student' + section.charAt(0).toUpperCase() + section.slice(1) + 'Section').style.display = 'block';

            // Update navigation
            document.querySelectorAll('.student-nav-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'text-purple-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-purple-500', 'text-purple-600');
        }

        // Contest Configuration
        document.getElementById('contestSelect').addEventListener('change', updateAreaOptions);

        function updateAreaOptions() {
            const contest = document.getElementById('contestSelect').value;
            const areaSelect = document.getElementById('areaSelect');
            
            areaSelect.innerHTML = '<option value="">Selecione uma área</option>';
            
            if (contest && contestAreas[contest]) {
                contestAreas[contest].forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
            }
        }

        async function saveContestConfig() {
            const contest = document.getElementById('contestSelect').value;
            const area = document.getElementById('areaSelect').value;

            if (!contest || !area) {
                alert('Por favor, selecione o concurso e a área');
                return;
            }

            try {
                await db.collection('users').doc(currentUser.uid).update({
                    contest: contest,
                    area: area
                });

                currentContest = contest;
                currentArea = area;

                loadStudyPlan();
                loadMaterials();
                loadSimulations();
                
                alert('Configuração salva com sucesso!');
            } catch (error) {
                alert('Erro ao salvar configuração');
            }
        }

        function loadStudyPlan() {
            if (!currentContest || !currentArea) return;

            const studyPlanSection = document.getElementById('studyPlanSection');
            const studyPlanContent = document.getElementById('studyPlanContent');
            
            studyPlanSection.style.display = 'block';
            
            const materials = studyMaterialsDB[currentContest]?.[currentArea];
            if (materials) {
                studyPlanContent.innerHTML = materials.topics.map(topic => `
                    <div class="bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg p-6 text-white card-hover">
                        <h3 class="text-lg font-semibold mb-2">${topic}</h3>
                        <p class="text-sm opacity-90 mb-4">Tópico essencial para ${currentArea}</p>
                        <button onclick="studyTopic('${topic}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition duration-300">
                            Estudar Agora
                        </button>
                    </div>
                `).join('');
            }
        }

        function loadMaterials() {
            if (!currentContest || !currentArea) return;

            const materialsContent = document.getElementById('materialsContent');
            const materials = studyMaterialsDB[currentContest]?.[currentArea];

            if (materials) {
                materialsContent.innerHTML = `
                    <div class="study-material rounded-lg p-6 card-hover">
                        <div class="text-center mb-4">
                            <i class="fas fa-video text-4xl text-red-600 mb-2"></i>
                            <h3 class="text-lg font-semibold">Videoaulas</h3>
                            <p class="text-gray-600 text-sm">${materials.videos.length} vídeos disponíveis</p>
                        </div>
                        <div class="space-y-2">
                            ${materials.videos.map(video => `
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm">${video.title}</span>
                                    <span class="text-xs text-gray-500">${video.duration}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="study-material rounded-lg p-6 card-hover">
                        <div class="text-center mb-4">
                            <i class="fas fa-file-pdf text-4xl text-red-600 mb-2"></i>
                            <h3 class="text-lg font-semibold">Material PDF</h3>
                            <p class="text-gray-600 text-sm">${materials.pdfs.length} arquivos disponíveis</p>
                        </div>
                        <div class="space-y-2">
                            ${materials.pdfs.map(pdf => `
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <span class="text-sm">${pdf.title}</span>
                                    <span class="text-xs text-gray-500">${pdf.pages} páginas</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="study-material rounded-lg p-6 card-hover">
                        <div class="text-center mb-4">
                            <i class="fas fa-brain text-4xl text-purple-600 mb-2"></i>
                            <h3 class="text-lg font-semibold">Exercícios IA</h3>
                            <p class="text-gray-600 text-sm">Gerados pela inteligência artificial</p>
                        </div>
                        <button onclick="generateAIExercises()" class="w-full gradient-bg text-white py-2 rounded-lg hover:opacity-90 transition duration-300">
                            Gerar Exercícios
                        </button>
                    </div>
                `;
            }
        }

        function loadSimulations() {
            if (!currentContest || !currentArea) return;

            const simulationsContent = document.getElementById('simulationsContent');
            
            simulationsContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white rounded-lg shadow-lg p-6 card-hover">
                        <div class="text-center mb-4">
                            <i class="fas fa-clock text-3xl text-blue-600 mb-2"></i>
                            <h3 class="text-lg font-semibold">Simulado Rápido</h3>
                            <p class="text-gray-600 text-sm">10 questões - 15 minutos</p>
                        </div>
                        <button onclick="startSimulation('quick')" class="w-full gradient-bg text-white py-2 rounded-lg hover:opacity-90 transition duration-300">
                            Iniciar
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6 card-hover">
                        <div class="text-center mb-4">
                            <i class="fas fa-clipboard-list text-3xl text-green-600 mb-2"></i>
                            <h3 class="text-lg font-semibold">Simulado Médio</h3>
                            <p class="text-gray-600 text-sm">25 questões - 45 minutos</p>
                        </div>
                        <button onclick="startSimulation('medium')" class="w-full gradient-bg text-white py-2 rounded-lg hover:opacity-90 transition duration-300">
                            Iniciar
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6 card-hover">
                        <div class="text-center mb-4">
                            <i class="fas fa-trophy text-3xl text-yellow-600 mb-2"></i>
                            <h3 class="text-lg font-semibold">Simulado Completo</h3>
                            <p class="text-gray-600 text-sm">50 questões - 90 minutos</p>
                        </div>
                        <button onclick="startSimulation('full')" class="w-full gradient-bg text-white py-2 rounded-lg hover:opacity-90 transition duration-300">
                            Iniciar
                        </button>
                    </div>
                </div>
            `;
        }

        // Simulation Functions
        function startSimulation(type) {
            if (!currentContest || !currentArea) {
                alert('Configure seu concurso primeiro');
                return;
            }

            const questions = questionBankDB[currentContest]?.[currentArea] || [];
            if (questions.length === 0) {
                alert('Nenhuma questão disponível para esta área');
                return;
            }

            let questionCount;
            let timeLimit;
            
            switch(type) {
                case 'quick':
                    questionCount = Math.min(10, questions.length);
                    timeLimit = 15;
                    break;
                case 'medium':
                    questionCount = Math.min(25, questions.length);
                    timeLimit = 45;
                    break;
                case 'full':
                    questionCount = Math.min(50, questions.length);
                    timeLimit = 90;
                    break;
            }

            const selectedQuestions = questions.slice(0, questionCount);
            showSimulationModal(selectedQuestions, timeLimit);
        }

        function showSimulationModal(questions, timeLimit) {
            const modal = document.getElementById('simulationModal');
            const title = document.getElementById('simulationTitle');
            const content = document.getElementById('simulationContent');

            title.textContent = `Simulado - ${currentArea} (${questions.length} questões)`;
            
            let currentQuestion = 0;
            let answers = [];
            let timeRemaining = timeLimit * 60; // Convert to seconds

            function renderQuestion() {
                const question = questions[currentQuestion];
                content.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm text-gray-600">Questão ${currentQuestion + 1} de ${questions.length}</span>
                            <span id="timer" class="text-sm font-semibold text-red-600">${Math.floor(timeRemaining / 60)}:${(timeRemaining % 60).toString().padStart(2, '0')}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
                            <div class="bg-purple-600 h-2 rounded-full progress-bar" style="width: ${((currentQuestion + 1) / questions.length) * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="question-card bg-gray-50 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">${question.question}</h3>
                        <div class="space-y-3">
                            ${question.options.map((option, index) => `
                                <label class="flex items-center p-3 bg-white rounded-lg border hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="answer" value="${index}" class="mr-3">
                                    <span>${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="flex justify-between">
                        <button onclick="previousQuestion()" ${currentQuestion === 0 ? 'disabled' : ''} 
                                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50">
                            Anterior
                        </button>
                        <button onclick="${currentQuestion === questions.length - 1 ? 'finishSimulation()' : 'nextQuestion()'}" 
                                class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90">
                            ${currentQuestion === questions.length - 1 ? 'Finalizar' : 'Próxima'}
                        </button>
                    </div>
                `;
            }

            window.nextQuestion = function() {
                const selectedAnswer = document.querySelector('input[name="answer"]:checked');
                if (selectedAnswer) {
                    answers[currentQuestion] = parseInt(selectedAnswer.value);
                    currentQuestion++;
                    renderQuestion();
                } else {
                    alert('Por favor, selecione uma resposta');
                }
            };

            window.previousQuestion = function() {
                if (currentQuestion > 0) {
                    currentQuestion--;
                    renderQuestion();
                }
            };

            window.finishSimulation = function() {
                const selectedAnswer = document.querySelector('input[name="answer"]:checked');
                if (selectedAnswer) {
                    answers[currentQuestion] = parseInt(selectedAnswer.value);
                }
                showSimulationResults(questions, answers);
            };

            // Timer
            const timerInterval = setInterval(() => {
                timeRemaining--;
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = `${Math.floor(timeRemaining / 60)}:${(timeRemaining % 60).toString().padStart(2, '0')}`;
                }
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert('Tempo esgotado!');
                    showSimulationResults(questions, answers);
                }
            }, 1000);

            renderQuestion();
            modal.style.display = 'flex';
        }

        function showSimulationResults(questions, answers) {
            let correct = 0;
            const results = questions.map((question, index) => {
                const isCorrect = answers[index] === question.correct;
                if (isCorrect) correct++;
                return { question, userAnswer: answers[index], isCorrect };
            });

            const percentage = Math.round((correct / questions.length) * 100);
            
            const content = document.getElementById('simulationContent');
            content.innerHTML = `
                <div class="text-center mb-8">
                    <div class="w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center ${percentage >= 70 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                        <i class="fas ${percentage >= 70 ? 'fa-check' : 'fa-times'} text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-2">${percentage}%</h2>
                    <p class="text-gray-600">Você acertou ${correct} de ${questions.length} questões</p>
                    <div class="mt-4">
                        <span class="px-4 py-2 rounded-full text-sm font-semibold ${percentage >= 70 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${percentage >= 70 ? 'Aprovado' : 'Precisa Melhorar'}
                        </span>
                    </div>
                </div>
                
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    ${results.map((result, index) => `
                        <div class="question-card ${result.isCorrect ? 'correct' : 'incorrect'} p-4 rounded-lg">
                            <h4 class="font-semibold mb-2">Questão ${index + 1}</h4>
                            <p class="text-sm text-gray-700 mb-2">${result.question.question}</p>
                            <p class="text-sm">
                                <strong>Sua resposta:</strong> ${result.question.options[result.userAnswer] || 'Não respondida'}
                            </p>
                            <p class="text-sm">
                                <strong>Resposta correta:</strong> ${result.question.options[result.question.correct]}
                            </p>
                            ${result.question.explanation ? `<p class="text-sm text-gray-600 mt-2"><strong>Explicação:</strong> ${result.question.explanation}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
                
                <div class="flex justify-center mt-8">
                    <button onclick="closeSimulation()" class="gradient-bg text-white px-8 py-3 rounded-lg hover:opacity-90">
                        Fechar
                    </button>
                </div>
            `;

            // Save results to user profile
            saveSimulationResult(correct, questions.length, percentage);
        }

        async function saveSimulationResult(correct, total, percentage) {
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userRef.get();
                const userData = userDoc.data();

                const newQuestionsAnswered = (userData.questionsAnswered || 0) + total;
                const newAccuracyRate = Math.round(((userData.accuracyRate || 0) * (userData.questionsAnswered || 0) + percentage * total) / newQuestionsAnswered);

                await userRef.update({
                    questionsAnswered: newQuestionsAnswered,
                    accuracyRate: newAccuracyRate,
                    lastSimulation: new Date().toISOString()
                });

                // Update display
                document.getElementById('questionsAnswered').textContent = newQuestionsAnswered;
                document.getElementById('accuracyRate').textContent = newAccuracyRate + '%';
            } catch (error) {
                console.error('Error saving simulation result:', error);
            }
        }

        function closeSimulation() {
            document.getElementById('simulationModal').style.display = 'none';
        }

        // Chat Functions
        async function sendMessage() {
            if (!userGeminiKey) {
                alert('Configure sua IA primeiro no Dashboard');
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';

            // Show typing indicator
            addTypingIndicator();

            try {
                // Call Gemini API
                const response = await callGeminiAPI(message);
                removeTypingIndicator();
                addMessageToChat(response, 'ai');
            } catch (error) {
                removeTypingIndicator();
                addMessageToChat('Desculpe, ocorreu um erro. Verifique sua conexão com a IA.', 'ai');
            }
        }

        async function callGeminiAPI(message) {
            if (!userGeminiKey) {
                throw new Error('IA não configurada');
            }

            // Construct context-aware prompt
            const contextPrompt = `Você é um professor virtual especializado em ${currentArea || 'educação'} para ${currentContest || 'concursos'}. 
            Responda de forma didática, clara e motivadora. Se a pergunta for sobre uma matéria específica, forneça explicações detalhadas com exemplos.
            
            Pergunta do aluno: ${message}`;

            const requestBody = {
                contents: [{
                    parts: [{
                        text: contextPrompt
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                }
            };

            const response = await fetch(`${GEMINI_API_URL}?key=${userGeminiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error('API request failed');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message mb-4';

            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex items-start justify-end">
                        <div class="bg-purple-600 text-white rounded-lg p-3 shadow-sm max-w-xs">
                            <p class="text-sm">${message}</p>
                        </div>
                        <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center ml-3">
                            <i class="fas fa-user text-gray-600 text-sm"></i>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm max-w-xs">
                            <p class="text-sm text-gray-800">${message}</p>
                        </div>
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'chat-message mb-4';
            typingDiv.innerHTML = `
                <div class="flex items-start">
                    <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white rounded-lg p-3 shadow-sm">
                        <p class="text-sm text-gray-800 typing-animation">Digitando...</p>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // AI Exercise Generation
        async function generateAIExercises() {
            if (!userGeminiKey) {
                alert('Configure sua IA primeiro no Dashboard');
                return;
            }

            if (!currentArea) {
                alert('Configure seu concurso primeiro');
                return;
            }

            try {
                const prompt = `Crie 5 questões de múltipla escolha sobre ${currentArea} para ${currentContest}. 
                Formato: Para cada questão, forneça:
                1. A pergunta
                2. 5 alternativas (a, b, c, d, e)
                3. A resposta correta
                4. Uma explicação breve
                
                Torne as questões desafiadoras mas justas para o nível do concurso.`;

                const response = await callGeminiAPI(prompt);
                
                // Display generated exercises
                const modal = document.getElementById('simulationModal');
                const title = document.getElementById('simulationTitle');
                const content = document.getElementById('simulationContent');

                title.textContent = `Exercícios Gerados por IA - ${currentArea}`;
                content.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-robot text-green-600 text-xl mr-3"></i>
                            <div>
                                <h3 class="font-semibold text-green-800">Exercícios Personalizados</h3>
                                <p class="text-sm text-green-600">Gerados especialmente para você pela IA</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-6 border">
                        <pre class="whitespace-pre-wrap text-sm text-gray-800">${response}</pre>
                    </div>
                    <div class="flex justify-center mt-6">
                        <button onclick="closeSimulation()" class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 mr-3">
                            Fechar
                        </button>
                        <button onclick="generateAIExercises()" class="border border-purple-600 text-purple-600 px-6 py-2 rounded-lg hover:bg-purple-50">
                            Gerar Novos
                        </button>
                    </div>
                `;

                modal.style.display = 'flex';
            } catch (error) {
                alert('Erro ao gerar exercícios. Verifique sua conexão e tente novamente.');
            }
        }

        function studyTopic(topic) {
            alert(`Iniciando estudo do tópico: ${topic}\n\nEm breve você terá acesso a conteúdo personalizado sobre este tópico!`);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96cc9e19a1fbf3f1',t:'MTc1NDc5ODc1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>



